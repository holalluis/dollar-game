<html><head>
<title>The Dollar Game</title>
<style>
  body{
    margin:0;
    background:black;
  }
  canvas{
    background:#666;
  }
</style>
</head><body>
<canvas></canvas>

<script>
  //get canvas element from DOM
  let canvas  = document.querySelector('canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  //constants
  const FONTSIZE = 30; //px | font cercle
  const MARGE    = 20; //px | marge canvas
  const N        = 10; //quantitat de cercles
  const RADI     = 35; //px | radi dels cercles

  //get canvas context
  let c = canvas.getContext('2d');
  c.font = `${FONTSIZE}px Helvetica`;

  class Cercle{
    constructor(x,y){
      this.x=x;
      this.y=y;
      this.radi=RADI;
      this.money=0;
      this.links=[]; //array of cirlce objects
    }

    crea_link(cercle){
      if(this.links.includes(cercle)){
        return false;
      }

      this.links.push(cercle);
      cercle.links.push(this);
    }

    dibuixa_links(){
      this.links.forEach(cercle=>{
        c.beginPath();

        if(this==cercle_seleccionat || cercle==cercle_seleccionat){
          c.strokeStyle="lightblue";
          c.lineWidth=3;
        }else{
          c.strokeStyle="black";
          c.lineWidth=1;
        }

        c.moveTo(this.x,   this.y);
        c.lineTo(cercle.x, cercle.y);

        c.stroke();
        c.closePath();
      });
    }

    dibuixa(){
      c.beginPath();
      c.arc(this.x,this.y,this.radi,0,2*Math.PI);

      if(this.money<0){
        c.fillStyle="red";
      }else{
        c.fillStyle="#af0";
      }
      c.fill();

      if(this==cercle_seleccionat){
        c.strokeStyle="lightblue";
        c.lineWidth=3;
      }else{
        c.strokeStyle="black";
        c.lineWidth=1;
      }

      c.stroke();

      c.closePath();

      //text centre cercle
      c.fillStyle = "black";
      let metrics = c.measureText(this.money);
      let height  = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
      c.fillText(this.money, this.x-metrics.width/2, this.y+height/2);
    }
  }

  //crea escena de cercles
  let cercles=[];
  for(let i=0;i<N;i++){
    let x = Math.max(MARGE + RADI, Math.random()*canvas.width  - RADI - MARGE);
    let y = Math.max(MARGE + RADI, Math.random()*canvas.height - RADI - MARGE);
    let c = new Cercle(x,y);
    if(i){
      c.crea_link(cercles[i-1]);
    }

    //TODO
    if(Math.random()>0.5){
      c.money=-1;
    }else{
      c.money=1;
    }

    cercles.push(c);
  }

  //mouse
  let cercle_seleccionat=null;
  let sha_mogut = false; //s'ha mogut un cercle? per evitar donar diners

  //moure mouse
  canvas.addEventListener("mousemove",function(event){
    let x = event.clientX;
    let y = event.clientY;

    if(cercle_seleccionat){
      cercle_seleccionat.x = x;
      cercle_seleccionat.y = y;
      sha_mogut = true;
    }
  });

  //seleccionar cercle
  canvas.addEventListener("mousedown",function(event){
    let x = event.clientX;
    let y = event.clientY;

    cercle_seleccionat = null;
    sha_mogut          = false;
    for(let i=0;i<cercles.length;i++){
      let c = cercles[i];
      let distance = Math.sqrt(Math.pow(c.x-x,2)+Math.pow(c.y-y,2));
      if(distance<=RADI){
        cercle_seleccionat=c;
        break;
      }
    }
  });

  //aixecar click mouse
  canvas.addEventListener("mouseup",function(event){
    let x = event.clientX;
    let y = event.clientY;

    //mou diners entre cercles
    if(cercle_seleccionat && !sha_mogut){
      cercle_seleccionat.money -= cercle_seleccionat.links.length;
      cercle_seleccionat.links.forEach(c=>c.money+=1);
    }

    cercle_seleccionat=null;
  });

  //touchstart
  canvas.addEventListener("touchstart",function(event){
    //console.log("touchstart");
    //console.log(event.touches);
    if(event.touches.length==0) return;
    event.stopPropagation();

    canvas.dispatchEvent(
      new MouseEvent("mousedown",{
        clientX:event.touches[0].clientX,
        clientY:event.touches[0].clientY,
      })
    );
  });

  //touchmove
  canvas.addEventListener("touchmove",function(event){
    //console.log("touchmove");
    if(event.touches.length==0) return;

    canvas.dispatchEvent(
      new MouseEvent("mousemove",{
        clientX:event.touches[0].clientX,
        clientY:event.touches[0].clientY,
      })
    );
  });

  //animation loop
  (function animate(){
    requestAnimationFrame(animate);
    c.clearRect(0,0,canvas.width,canvas.height);

    cercles.forEach(c=>c.dibuixa_links() );
    cercles.forEach(c=>c.dibuixa()       );
  })();
</script>
