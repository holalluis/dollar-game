<html><head>
<title>The Dollar Game</title>
<style>
  body{
    margin:0;
    background:black;
  }
  canvas{
    background:#666;
  }
</style>
</head><body>
<canvas></canvas>
<iframe width="560" height="315" src="https://www.youtube.com/embed/U33dsEcKgeQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<script>
  //get canvas element from DOM
  let canvas  = document.querySelector('canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  //constants
  const N     = 20; //quantitat de cercles
  const RADI   = 35; //px | radi dels cercles
  const MARGE   = 20; //px | marge canvas
  const FONTSIZE = 30; //px | font cercle

  //get canvas context
  let c  = canvas.getContext('2d');
  c.font = `${FONTSIZE}px Helvetica`;

  class Cercle{
    constructor(x,y){
      this.x=x;
      this.y=y;
      this.money=0;
      this.links=[]; //array of cirlce objects
    }

    crea_link(cercle){
      if(this.links.includes(cercle)){
        return false;
      }

      this.links.push(cercle);
      cercle.links.push(this);
    }

    //dibuixa els links al canvas
    dibuixa_links(){
      this.links.forEach(cercle=>{
        c.beginPath();

        if(this==cercle_seleccionat || cercle==cercle_seleccionat){
          c.strokeStyle="lightblue";
          c.lineWidth=3;
        }else{
          c.strokeStyle="black";
          c.lineWidth=1;
        }

        c.moveTo(this.x,   this.y);
        c.lineTo(cercle.x, cercle.y);

        c.stroke();
        c.closePath();
      });
    }

    //dibuixa el cercle al canvas
    dibuixa(){
      c.beginPath();
      c.arc(this.x, this.y, RADI,0,2*Math.PI);

      if(this.money<0){
        c.fillStyle="red";
      }else{
        c.fillStyle="#af0";
      }
      c.fill();

      if(this==cercle_seleccionat){
        c.strokeStyle="lightblue";
        c.lineWidth=3;
      }else{
        c.strokeStyle="black";
        c.lineWidth=1;
      }

      c.stroke();

      c.closePath();

      //text centre cercle
      c.fillStyle = "black";
      let metrics = c.measureText(this.money);
      let height  = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
      c.fillText(this.money, this.x-metrics.width/2, this.y+height/2);
    }
  }

  //crea escena de cercles
  let cercles=[];
  for(let i=0;i<N;i++){
    let x = Math.max(MARGE + RADI, Math.random()*canvas.width  - RADI - MARGE);
    let y = Math.max(MARGE + RADI, Math.random()*canvas.height - RADI - MARGE);
    let c = new Cercle(x,y);
    cercles.push(c);

    //diners aleatoris (positius o negatius)
    c.money = Math.floor(Math.random()*N - N/2);
  }

  for(let i=0;i<N;i++){
    let c = cercles[i];

    let n = 1+Math.floor(3*Math.random());
    for(let j=0;j<n;j++){
      let index_random = Math.floor(Math.random()*N);
      c.crea_link(cercles[index_random]);
    }

  }

  //calcula suma d'arestes
  let suma_arestes = cercles.map(c=>c.links.length).reduce((p,c)=>p+c,0)/2;

  //calcula "genus" = arestes - vertexs +1
  //una partida es podrà guanyar si la suma de diners és com a mínim el genus
  let genus = suma_arestes - N + 1;

  //calcula suma de diners
  let suma_dolars = cercles.map(c=>c.money).reduce((p,c)=>p+c,0);
  while(suma_dolars<genus){
    let index_random = Math.floor(Math.random()*N);
    cercles[index_random].money++;
    suma_dolars = cercles.map(c=>c.money).reduce((p,c)=>p+c,0);
  }

  console.log({N,suma_dolars,suma_arestes, genus});

  //mouse
  let cercle_seleccionat=null;
  let sha_mogut = false; //s'ha mogut un cercle? per evitar donar diners

  //moure mouse
  canvas.addEventListener("mousemove",function(event){
    let bounding = canvas.getBoundingClientRect();

    let x = event.clientX - bounding.left;
    let y = event.clientY - bounding.top;

    if(cercle_seleccionat){
      cercle_seleccionat.x = x;
      cercle_seleccionat.y = y;
      sha_mogut = true;
    }
  });

  //seleccionar cercle
  canvas.addEventListener("mousedown",function(event){
    let bounding = canvas.getBoundingClientRect();

    let x = event.clientX - bounding.left;
    let y = event.clientY - bounding.top;

    cercle_seleccionat = null;
    sha_mogut          = false;
    for(let i=0;i<cercles.length;i++){
      let c = cercles[i];
      let distance = Math.sqrt(Math.pow(c.x-x,2)+Math.pow(c.y-y,2));
      if(distance<=RADI){
        cercle_seleccionat=c;
        break;
      }
    }
  });

  //aixecar click mouse
  canvas.addEventListener("mouseup",function(event){
    //mou diners entre cercles
    if(cercle_seleccionat && !sha_mogut){
      cercle_seleccionat.money -= cercle_seleccionat.links.length;
      cercle_seleccionat.links.forEach(c=>c.money+=1);
    }
    cercle_seleccionat=null;
  });

  //touchstart
  canvas.addEventListener("touchstart",function(event){
    if(event.touches.length==0) return;
    event.stopPropagation();

    canvas.dispatchEvent(
      new MouseEvent("mousedown",{
        clientX:event.touches[0].clientX,
        clientY:event.touches[0].clientY,
      })
    );
  });

  //touchmove
  canvas.addEventListener("touchmove",function(event){
    if(event.touches.length==0) return;

    canvas.dispatchEvent(
      new MouseEvent("mousemove",{
        clientX:event.touches[0].clientX,
        clientY:event.touches[0].clientY,
      })
    );
  });

  //animation loop
  (function animate(){
    requestAnimationFrame(animate);
    c.clearRect(0,0,canvas.width,canvas.height);

    cercles.forEach(c=>c.dibuixa_links() );
    cercles.forEach(c=>c.dibuixa()       );
  })();
</script>
